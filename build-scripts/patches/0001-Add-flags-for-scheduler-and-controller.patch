From 5d91e541e1df3891e8846c9209d84ce547e9ebe0 Mon Sep 17 00:00:00 2001
From: Konstantinos Tsakalozos <kos.tsakalozos@canonical.com>
Date: Mon, 11 Oct 2021 12:43:01 +0300
Subject: [PATCH] Add flags for scheduler and controller

---
 cmd/kubelite/app/options/options.go |  4 ++++
 cmd/kubelite/app/server.go          | 14 ++++++++++----
 2 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/cmd/kubelite/app/options/options.go b/cmd/kubelite/app/options/options.go
index 80f1d8b09fc..5d80b3a96a3 100644
--- a/cmd/kubelite/app/options/options.go
+++ b/cmd/kubelite/app/options/options.go
@@ -26,7 +26,9 @@ import (
 // Options has all the params needed to run a Kubelite
 type Options struct {
 	SchedulerArgsFile         string
+	StartScheduler            bool
 	ControllerManagerArgsFile string
+	StartControllerManager    bool
 	ProxyArgsFile             string
 	KubeletArgsFile           string
 	APIServerArgsFile         string
@@ -37,7 +39,9 @@ type Options struct {
 func NewOptions() (*Options){
 	o := Options{
 		"/var/snap/microk8s/current/args/kube-scheduler",
+		true,
 		"/var/snap/microk8s/current/args/kube-controller-manager",
+		true,
 		"/var/snap/microk8s/current/args/kube-proxy",
 		"/var/snap/microk8s/current/args/kubelet",
 		"/var/snap/microk8s/current/args/kube-apiserver",
diff --git a/cmd/kubelite/app/server.go b/cmd/kubelite/app/server.go
index e7452a09e3e..69be1a06ea8 100644
--- a/cmd/kubelite/app/server.go
+++ b/cmd/kubelite/app/server.go
@@ -42,11 +42,15 @@ var liteCmd = &cobra.Command{
 			go daemon.StartAPIServer(apiserverArgs, ctx.Done())
 			daemon.WaitForAPIServer(opts.KubeconfigFile, 360 * time.Second)
 
-			controllerArgs := options.ReadArgsFromFile(opts.ControllerManagerArgsFile)
-			go daemon.StartControllerManager(controllerArgs, ctx)
+			if opts.StartControllerManager {
+				controllerArgs := options.ReadArgsFromFile(opts.ControllerManagerArgsFile)
+				go daemon.StartControllerManager(controllerArgs, ctx)
+			}
 
-			schedulerArgs := options.ReadArgsFromFile(opts.SchedulerArgsFile)
-			go daemon.StartScheduler(schedulerArgs, ctx)
+			if opts.StartScheduler {
+				schedulerArgs := options.ReadArgsFromFile(opts.SchedulerArgsFile)
+				go daemon.StartScheduler(schedulerArgs, ctx)
+			}
 		}
 
 		proxyArgs := options.ReadArgsFromFile(opts.ProxyArgsFile)
@@ -70,7 +74,9 @@ func init() {
 	cobra.OnInitialize()
 
 	liteCmd.Flags().StringVar(&opts.SchedulerArgsFile, "scheduler-args-file", opts.SchedulerArgsFile, "file with the arguments for the scheduler")
+	liteCmd.Flags().BoolVar(&opts.StartScheduler, "start-scheduler", opts.StartScheduler, "start the scheduler")
 	liteCmd.Flags().StringVar(&opts.ControllerManagerArgsFile, "controller-manager-args-file", opts.ControllerManagerArgsFile, "file with the arguments for the controller manager")
+	liteCmd.Flags().BoolVar(&opts.StartControllerManager, "start-controller-manager", opts.StartControllerManager, "start the controller manager")
 	liteCmd.Flags().StringVar(&opts.ProxyArgsFile, "proxy-args-file", opts.ProxyArgsFile , "file with the arguments for kube-proxy")
 	liteCmd.Flags().StringVar(&opts.KubeletArgsFile, "kubelet-args-file", opts.KubeletArgsFile, "file with the arguments for kubelet")
 	liteCmd.Flags().StringVar(&opts.APIServerArgsFile, "apiserver-args-file", opts.APIServerArgsFile, "file with the arguments for the API server")
-- 
2.25.1

